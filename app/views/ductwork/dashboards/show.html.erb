<div>
  <div class="grid metrics">
    <%= link_to(pipelines_path(status: "completed"), class: "stealthy-link") do %>
      <article>
        <div class="metric-heading">Completed Pipelines</div>
        <h1 class="metric-value"><%= number_with_delimiter(@metrics[:completed]) %></h1>
      </article>
    <% end %>

    <%= link_to(pipelines_path(status: "in_progress"), class: "stealthy-link") do %>
      <article>
        <div class="metric-heading">In-Progress Pipelines</div>
        <h1 class="metric-value"><%= number_with_delimiter(@metrics[:in_progress]) %></h1>
      </article>
    <% end %>

    <%= link_to(pipelines_path(status: "halted"), class: "stealthy-link") do %>
      <article>
        <div class="metric-heading">Halted Pipelines</div>
        <h1 class="metric-value"><%= number_with_delimiter(@metrics[:halted]) %></h1>
      </article>
    <% end %>

    <%= link_to(step_errors_path, class: "stealthy-link") do %>
      <article>
        <div class="metric-heading">Step Errors</div>
        <h1 class="metric-value"><%= @metrics[:step_errors] %></h1>
      </article>
    <% end %>
  </div>

  <div>
    <h1>All Pipelines</h1>
    <div class="separate-content">
      <div class="filter-group">
        <span class="filter-group-item">Filters:</span>

        <details class="dropdown filter-group-item">
          <summary>Class</summary>
          <ul>
            <% @klasses.each do |klass| %>
              <li>
                <%= link_to(klass, pipelines_path(klass:)) %>
              </li>
            <% end %>
          </ul>
        </details>

        <details class="dropdown filter-group-item">
          <summary>Status</summary>
          <ul>
            <% @statuses.each do |status| %>
              <li>
                <%= link_to(status.gsub("_", "-"), pipelines_path(status:)) %>
              </li>
            <% end %>
          </ul>
        </details>
      </div>

      <div role="group" style="width: auto;">
        <button <%= first_page? && "disabled" %> data-href="<%= previous_page_path %>">
          &larr;
        </button>
        <button data-href="<%= next_page_path %>">
          &rarr;
        </button>
      </div>
    </div>

    <table class="striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Class</th>
          <th>Status</th>
          <th>Errors</th>
          <th>Started At</th>
          <th>Runtime</th>
        </tr>
      </thead>
      <tbody>
        <% @pipelines.each do |pipeline| %>
          <tr class="row-link" data-href="<%= pipeline_path(pipeline.id) %>">
            <td>
              <code>
                <%= pipeline.id %>
              </code>
            </td>
            <td>
              <code>
                <%= pipeline.klass %>
              </code>
            </td>
            <td>
              <div class="status-pill <%= pipeline.status %>">
                <%= pipeline.status.gsub("_", "-") %>
              </div>
            </td>
            <td>
              <%
                count = Ductwork::Result
                        .joins(execution: { job: { step: :pipeline }})
                        .failure
                        .where(ductwork_pipelines: { id: pipeline.id })
                        .count
              %>
              <% if count.zero? %>
                0
              <% else %>
                <div class="errors">
                  <%= image_tag("ductwork/octagon-x.svg", class: "icon") %>
                  <%= count %>
                </div>
              <% end %>
            </td>
            <td>
              <div class="tight-timestamp">
                <%= pipeline.started_at.iso8601(3) %>
              </div>
            </td>
            <td>
              <% if pipeline.completed_at.nil? %>
                <div data-started-at=<%= pipeline.started_at.iso8601 %>>
                  <span id="elapsed-timer">0h 0m 0s</span>
                </div>
              <% else %>
                <%= formatted_time_distance(pipeline.started_at, pipeline.completed_at) %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
